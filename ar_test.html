<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>WebXR AR Example</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        /* Toast Notification Styles */
        .toast {
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px;
            background-color: #333;
            color: #fff;
            border-radius: 5px;
            font-size: 14px;
            display: none;
            z-index: 1000;
        }
    </style>
</head>
<body style="margin: 0; overflow: hidden;">

<button id="start-ar" style="position: absolute; top: 10px; left: 10px; z-index: 10; padding: 10px;">
    Start AR
</button>

<div id="toast" class="toast"></div>

<script>
let scene, camera, renderer, controller, reticle, referenceSpace, hitTestSource;

function showToast(message, duration = 3000) {
    const toast = document.getElementById("toast");
    toast.innerText = message;
    toast.style.display = "block";
    setTimeout(() => {
        toast.style.display = "none";
    }, duration);
}

function checkCameraPermissions() {
    if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
        navigator.mediaDevices.getUserMedia({ video: true })
            .then(function(stream) {
                showToast("Camera access granted.");
                // Proceed with initializing AR
                startARSession();
            })
            .catch(function(error) {
                console.error("Camera access denied:", error);
                showToast("Camera access denied. Please enable camera access for AR.", 5000);
            });
    } else {
        console.error("getUserMedia not supported.");
        showToast("Camera access not supported on this device.", 5000);
    }
}

function initialize() {
    // Scene setup
    scene = new THREE.Scene();

    // Camera setup
    camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 100);
    scene.add(camera);

    // Renderer setup
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);

    // Light setup
    const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
    scene.add(light);

    // Reticle for placing objects
    const geometry = new THREE.RingGeometry(0.1, 0.15, 32).rotateX(-Math.PI / 2);
    const material = new THREE.MeshBasicMaterial({ color: 0xffffff });
    reticle = new THREE.Mesh(geometry, material);
    reticle.matrixAutoUpdate = false;
    reticle.visible = false;
    scene.add(reticle);

    renderer.setAnimationLoop(render);
}

async function startARSession() {
    if (!navigator.xr) {
        alert("WebXR not supported on this browser.");
        showToast("WebXR not supported on this browser.", 5000);
        return;
    }

    try {
        console.log("Requesting AR session...");
        showToast("Requesting AR session...");
        const xrSession = await navigator.xr.requestSession('immersive-ar', { requiredFeatures: ['hit-test', 'local'] });
        renderer.xr.setSession(xrSession);

        xrSession.addEventListener('end', onSessionEnd);
        referenceSpace = await xrSession.requestReferenceSpace('local');

        hitTestSource = await xrSession.requestHitTestSource({
            space: await xrSession.requestReferenceSpace('viewer'),
        });

        initializeScene();
        renderer.setAnimationLoop(render);
        showToast("AR session started successfully.");
        document.getElementById('start-ar').style.display = 'none';
    } catch (err) {
        console.error("Failed to start AR session:", err);
        showToast("Failed to start AR session. Please check your device compatibility.", 5000);
    }
}

function onSessionEnd() {
    renderer.xr.getSession().end();
    document.getElementById('start-ar').style.display = 'block';
    showToast("AR session ended.");
}

function render(timestamp, frame) {
    if (frame) {
        const referenceSpace = renderer.xr.getReferenceSpace();
        const hitTestSourceResult = frame.getHitTestResults(hitTestSource)[0];

        if (hitTestSourceResult) {
            const hitPose = hitTestSourceResult.getPose(referenceSpace);
            reticle.visible = true;
            reticle.matrix.fromArray(hitPose.transform.matrix);
        } else {
            reticle.visible = false;
        }
    }
    renderer.render(scene, camera);
}

// Add event listener for user interaction
document.getElementById('start-ar').addEventListener('click', function() {
    checkCameraPermissions(); // Call this function when the user clicks the 'Start AR' button
    initialize();
});
</script>

</body>
</html>
