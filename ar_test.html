<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>WebXR AR Example</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }
        #start-ar {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 10;
            padding: 10px;
        }
        .toast {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 5px;
            display: none;
        }
    </style>
</head>
<body>

<button id="start-ar">Start AR</button>
<div id="toast" class="toast"></div>

<script>
let scene, camera, renderer, controller, reticle;
const toast = document.getElementById('toast');

function showToast(message) {
    toast.textContent = message;
    toast.style.display = 'block';
    setTimeout(() => {
        toast.style.display = 'none';
    }, 3000);
}

function initialize() {
    // Scene setup
    scene = new THREE.Scene();

    // Camera setup
    camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 100);
    scene.add(camera);

    // Renderer setup
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.xr.enabled = true;
    document.body.appendChild(renderer.domElement);

    // Light setup
    const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
    scene.add(light);

    // Reticle for placing objects
    const geometry = new THREE.RingGeometry(0.1, 0.15, 32).rotateX(-Math.PI / 2);
    const material = new THREE.MeshBasicMaterial({ color: 0xffffff });
    reticle = new THREE.Mesh(geometry, material);
    reticle.matrixAutoUpdate = false;
    reticle.visible = false;
    scene.add(reticle);

    renderer.setAnimationLoop(render);
}

function startARSession() {
    if (navigator.xr) {
        navigator.xr.isSessionSupported('immersive-ar').then((supported) => {
            if (supported) {
                navigator.xr.requestSession('immersive-ar', { optionalFeatures: ['hit-test'] })
                    .then((session) => {
                        renderer.xr.setSession(session);
                        showToast("AR Session Started");
                        initialize();
                    })
                    .catch((err) => {
                        console.error("Failed to start AR session:", err);
                        showToast("Failed to start AR session. Please check your device compatibility.");
                    });
            } else {
                console.error("WebXR immersive-ar session is not supported on this device.");
                showToast("AR is not supported on this device.");
            }
        });
    } else {
        console.error("WebXR API not available.");
        showToast("WebXR API is not available on this browser.");
    }
}

function render(timestamp, frame) {
    if (frame) {
        const referenceSpace = renderer.xr.getReferenceSpace();
        const hitTestSource = frame.getHitTestResults(referenceSpace)[0];

        if (hitTestSource) {
            const hit = hitTestSource.getPose(referenceSpace);
            reticle.visible = true;
            reticle.matrix.fromArray(hit.transform.matrix);
        } else {
            reticle.visible = false;
        }
    }
    renderer.render(scene, camera);
}

document.getElementById('start-ar').addEventListener('click', () => {
    startARSession();
    document.getElementById('start-ar').style.display = 'none'; // Hide the button after starting AR
});
</script>

</body>
</html>
